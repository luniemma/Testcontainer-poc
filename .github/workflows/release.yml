name: ğŸ‰ Release Pipeline

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write         # For creating releases and checking out code
  checks: write           # For publishing test results
  pull-requests: write    # For PR-related operations
  issues: write           # CRITICAL: For creating comments (PRs are issues in GitHub API)
  security-events: write  # For security scanning (CodeQL/OWASP)
  actions: read           # For downloading artifacts
  packages: write         # For pushing Docker images (if using GHCR)

jobs:
  
  #######################################
  # PRE-RELEASE VALIDATION
  #######################################
  pre-release:
    name: ğŸ” Pre-Release Validation
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      is-prerelease: ${{ steps.check.outputs.is-prerelease }}
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for changelog
      
      - name: ğŸ¯ Print Release Information
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                â•‘"
          echo "â•‘              ğŸ‰ RELEASE PIPELINE STARTING ğŸ‰                  â•‘"
          echo "â•‘                                                                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚                    RELEASE INFORMATION                         â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "ğŸ·ï¸  Tag:              ${{ github.ref_name }}"
          echo "ğŸ“¦ Repository:        ${{ github.repository }}"
          echo "ğŸ“ Commit SHA:        ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by:      ${{ github.actor }}"
          echo "â° Started at:        $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ” Extract Version Information
        id: extract
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"  # Remove 'v' prefix
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“"
          echo "â”ƒ              ğŸ” Version Analysis                           â”ƒ"
          echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"
          echo ""
          echo "ğŸ“Œ Full Tag:          $TAG"
          echo "ğŸ“Œ Version:           $VERSION"
          echo ""
          
          # Parse version components
          if [[ $VERSION =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)(-.*)?$ ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
            SUFFIX="${BASH_REMATCH[4]}"
            
            echo "ğŸ”¢ Major:             $MAJOR"
            echo "ğŸ”¢ Minor:             $MINOR"
            echo "ğŸ”¢ Patch:             $PATCH"
            
            if [ -n "$SUFFIX" ]; then
              echo "ğŸ·ï¸  Suffix:           $SUFFIX"
            fi
            
            echo ""
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "major=$MAJOR" >> $GITHUB_OUTPUT
            echo "minor=$MINOR" >> $GITHUB_OUTPUT
            echo "patch=$PATCH" >> $GITHUB_OUTPUT
            echo "suffix=$SUFFIX" >> $GITHUB_OUTPUT
            
            echo "âœ… Version parsed successfully"
          else
            echo "âŒ ERROR: Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix"
            exit 1
          fi
      
      - name: ğŸ·ï¸ Check Release Type
        id: check
        run: |
          VERSION="${{ steps.extract.outputs.version }}"
          SUFFIX="${{ steps.extract.outputs.suffix }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“"
          echo "â”ƒ              ğŸ·ï¸  Release Type Detection                   â”ƒ"
          echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"
          echo ""
          
          if [ -n "$SUFFIX" ]; then
            if [[ $SUFFIX =~ ^-(alpha|beta|rc) ]]; then
              echo "ğŸ¯ Release Type:      Pre-release"
              echo "ğŸ“Œ Stage:             $SUFFIX"
              echo "is-prerelease=true" >> $GITHUB_OUTPUT
              RELEASE_TYPE="Pre-release"
            else
              echo "ğŸ¯ Release Type:      Release (with suffix)"
              echo "ğŸ“Œ Suffix:            $SUFFIX"
              echo "is-prerelease=false" >> $GITHUB_OUTPUT
              RELEASE_TYPE="Release"
            fi
          else
            echo "ğŸ¯ Release Type:      Production Release"
            echo "ğŸ“Œ Stage:             Stable"
            echo "is-prerelease=false" >> $GITHUB_OUTPUT
            RELEASE_TYPE="Production"
          fi
          
          echo ""
          echo "âœ… Release type identified: $RELEASE_TYPE"
      
      - name: ğŸ“Š Create Pre-Release Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> $GITHUB_STEP_SUMMARY
          echo "â•‘                                                              â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•‘              ğŸ‰ RELEASE PIPELINE INITIATED                  â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•‘                                                              â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "<div align='center'>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ·ï¸ Release Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ·ï¸ Tag | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Œ Version | **${{ steps.extract.outputs.version }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¢ Major | ${{ steps.extract.outputs.major }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¢ Minor | ${{ steps.extract.outputs.minor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¢ Patch | ${{ steps.extract.outputs.patch }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.extract.outputs.suffix }}" ]; then
            echo "| ğŸ·ï¸ Suffix | \`${{ steps.extract.outputs.suffix }}\` |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.check.outputs.is-prerelease }}" == "true" ]; then
            echo "| ğŸ¯ Type | **Pre-release** âš ï¸ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ¯ Type | **Production Release** âœ… |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "| ğŸ‘¤ Released By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â° Started | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</div>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸš€ Release Stages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following stages will be executed:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. âœ… **Pre-Release Validation** (Current)" >> $GITHUB_STEP_SUMMARY
          echo "2. ğŸ—ï¸ **Build & Test** â†’ Full CI/CD pipeline" >> $GITHUB_STEP_SUMMARY
          echo "3. ğŸ“ **Create GitHub Release** â†’ Generate release notes" >> $GITHUB_STEP_SUMMARY
          echo "4. ğŸ‰ **Post-Release** â†’ Cleanup and notifications" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY


  #######################################
  # MAIN RELEASE BUILD
  #######################################
  release:
    name: ğŸ—ï¸ Build & Test Release
    needs: pre-release
    uses: ./.github/workflows/ci-cd.yml
    # âœ… Explicitly pass permissions to reusable workflow
    permissions:
      contents: write
      checks: write
      pull-requests: write
      issues: write          # CRITICAL: For creating comments
      security-events: write
    with:
      java-version: "17"
      docker-platforms: "linux/amd64,linux/arm64"
      run-tests: true
      enable-security-scan: true
      sonar-token: ""        # ğŸ”¥ NEVER put secrets here
      event-name: ${{ github.event_name }}
      debug-mode: false
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      TC_CLOUD_TOKEN: ${{ secrets.TC_CLOUD_TOKEN }}


  #######################################
  # CREATE GITHUB RELEASE
  #######################################
  create-release:
    name: ğŸ“ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [pre-release, release]
    if: always() && !cancelled() && needs.release.result == 'success'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for changelog
      
      - name: ğŸ¯ Print Release Creation Info
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "           ğŸ“  CREATING GITHUB RELEASE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ·ï¸  Version:          ${{ needs.pre-release.outputs.version }}"
          echo "ğŸ¯ Type:              ${{ needs.pre-release.outputs.is-prerelease == 'true' && 'Pre-release' || 'Production' }}"
          echo "ğŸ³ Docker Image:      ${{ needs.release.outputs.image-tag }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ“‹ Generate Changelog
        id: changelog
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“"
          echo "â”ƒ              ğŸ“‹ Generating Changelog                       â”ƒ"
          echo "â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›"
          echo ""
          
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            echo "ğŸ“Œ Previous Tag:      $PREV_TAG"
            echo "ğŸ“Œ Current Tag:       ${{ github.ref_name }}"
            echo ""
            echo "ğŸ” Commits since $PREV_TAG:"
            echo ""
            
            # Generate changelog
            git log $PREV_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges > changelog.txt
            
            if [ -s changelog.txt ]; then
              cat changelog.txt
              echo ""
              echo ""
              echo "âœ… Changelog generated with $(wc -l < changelog.txt) commits"
            else
              echo "- Initial release" > changelog.txt
              echo "âœ… No previous commits (initial release)"
            fi
          else
            echo "ğŸ“Œ No previous tag found"
            echo "ğŸ“ Creating initial release changelog"
            echo ""
            echo "- Initial release" > changelog.txt
            echo "âœ… Initial release changelog created"
          fi
          
          # âœ… FIX: Use unique delimiter to avoid conflicts with commit messages
          # Using timestamp ensures the delimiter won't appear in any commit message
          DELIMITER="CHANGELOG_END_$(date +%s%N)"
          
          {
            echo "changelog<<${DELIMITER}"
            cat changelog.txt
            echo "${DELIMITER}"
          } >> $GITHUB_OUTPUT
          
          echo ""
          echo "âœ… Changelog saved to output"
      
      - name: ğŸ“¦ Download Build Artifacts (if available)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: ./artifacts
      
      - name: ğŸ“ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: Release ${{ needs.pre-release.outputs.version }}
          tag_name: ${{ github.ref_name }}
          prerelease: ${{ needs.pre-release.outputs.is-prerelease == 'true' }}
          generate_release_notes: true
          body: |
            ## ğŸ‰ Release ${{ needs.pre-release.outputs.version }}
            
            **Release Type:** ${{ needs.pre-release.outputs.is-prerelease == 'true' && 'âš ï¸ Pre-release' || 'âœ… Production Release' }}
            
            ### ğŸ“¦ Artifacts
            
            **Docker Image:**
            ```bash
            docker pull ${{ needs.release.outputs.image-tag }}
            ```
            
            ### ğŸ“‹ Changes in this Release
            
            ${{ steps.changelog.outputs.changelog }}
            
            ### ğŸ”’ Security
            
            - âœ… All security scans passed
            - âœ… OWASP dependency check completed
            - âœ… CodeQL analysis completed
            
            ### ğŸ§ª Testing
            
            - âœ… All unit tests passed
            - âœ… All integration tests passed
            - âœ… Smoke tests completed successfully
            
            ---
            
            **Released by:** @${{ github.actor }}
            **Release date:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          files: |
            ./artifacts/*.jar
      
      - name: âœ… Release Created Successfully
        run: |
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚          âœ… GitHub Release Created Successfully            â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "ğŸ·ï¸  Version:          ${{ needs.pre-release.outputs.version }}"
          echo "ğŸ”— Release URL:       ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          echo ""
      
      - name: ğŸ“Š Create Release Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> $GITHUB_STEP_SUMMARY
          echo "â•‘                                                              â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•‘              ğŸ“ GITHUB RELEASE CREATED                      â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•‘                                                              â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "<div align='center'>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ·ï¸ Version | **${{ needs.pre-release.outputs.version }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¯ Type | ${{ needs.pre-release.outputs.is-prerelease == 'true' && 'âš ï¸ Pre-release' || 'âœ… Production' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ³ Docker Image | \`${{ needs.release.outputs.image-tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ‘¤ Released By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â° Created At | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</div>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ“¦ [View Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ³ Docker: \`docker pull ${{ needs.release.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ¯ Deployment Command" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull the Docker image" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ needs.release.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Run the container" >> $GITHUB_STEP_SUMMARY
          echo "docker run -p 8080:8080 ${{ needs.release.outputs.image-tag }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY


  #######################################
  # POST-RELEASE TASKS
  #######################################
  post-release:
    name: ğŸ‰ Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [pre-release, release, create-release]
    if: always()
    
    steps:
      - name: ğŸ“Š Print Final Status
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "           ğŸ‰  RELEASE PIPELINE COMPLETED"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          echo "ğŸ“‹ Pipeline Results:"
          echo "  â€¢ Pre-Release:      ${{ needs.pre-release.result }}"
          echo "  â€¢ Build & Test:     ${{ needs.release.result }}"
          echo "  â€¢ Create Release:   ${{ needs.create-release.result }}"
          echo ""
          
          if [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                                                           â•‘"
            echo "â•‘        ğŸ‰ RELEASE PUBLISHED SUCCESSFULLY! ğŸ‰             â•‘"
            echo "â•‘                                                           â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          else
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘                                                           â•‘"
            echo "â•‘           âš ï¸  RELEASE PIPELINE FAILED  âš ï¸               â•‘"
            echo "â•‘                                                           â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          fi
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ“ˆ Create Final Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> $GITHUB_STEP_SUMMARY
          echo "â•‘                                                                â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•‘              ğŸ RELEASE PIPELINE COMPLETED                    â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•‘                                                                â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "<div align='center'>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "## ğŸ‰ RELEASE SUCCESSFUL!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘                                                   â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘     ğŸš€ VERSION ${{ needs.pre-release.outputs.version }} RELEASED! ğŸš€        â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘                                                   â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘    âœ… Built                                       â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘    âœ… Tested                                      â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘    âœ… Secured                                     â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘    âœ… Published                                   â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘                                                   â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ RELEASE FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘                                                   â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘        âš ï¸  RELEASE PIPELINE FAILED  âš ï¸           â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘                                                   â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘      Please review the logs above                 â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘                                                   â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</div>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Pipeline stages summary
          echo "### ğŸ“‹ Pipeline Stages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<div align='center'>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.pre-release.result }}" == "success" ]; then
            echo "| ğŸ” Pre-Release Validation | âœ… **SUCCESS** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ” Pre-Release Validation | âŒ **FAILED** |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.release.result }}" == "success" ]; then
            echo "| ğŸ—ï¸ Build & Test | âœ… **SUCCESS** |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ—ï¸ Build & Test | âŒ **FAILED** |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "| ğŸ“ Create Release | âœ… **SUCCESS** |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.create-release.result }}" == "skipped" ]; then
            echo "| ğŸ“ Create Release | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ğŸ“ Create Release | âŒ **FAILED** |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</div>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Release information (if successful)
          if [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "### ğŸ¯ Release Details" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ·ï¸ Version | **${{ needs.pre-release.outputs.version }}** |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ¯ Type | ${{ needs.pre-release.outputs.is-prerelease == 'true' && 'âš ï¸ Pre-release' || 'âœ… Production' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ³ Docker Image | \`${{ needs.release.outputs.image-tag }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ğŸ‘¤ Released By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
            echo "| â° Completed At | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ğŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. ğŸ“¦ [View the release](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
            echo "2. ğŸ³ Pull the Docker image: \`docker pull ${{ needs.release.outputs.image-tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "3. ğŸ“ Update deployment documentation" >> $GITHUB_STEP_SUMMARY
            echo "4. ğŸ”” Notify stakeholders of the new release" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ needs.pre-release.outputs.is-prerelease }}" == "true" ]; then
              echo "5. âš ï¸ **Note**: This is a pre-release - test thoroughly before production deployment" >> $GITHUB_STEP_SUMMARY
            else
              echo "5. âœ… Deploy to production environment" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ğŸ” Troubleshooting" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Check the failed job logs above" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify version tag format (v*.*.* )" >> $GITHUB_STEP_SUMMARY
            echo "3. Ensure all tests pass locally" >> $GITHUB_STEP_SUMMARY
            echo "4. Check that all secrets are configured" >> $GITHUB_STEP_SUMMARY
            echo "5. Review security scan results" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "<div align='center'>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Release pipeline completed at $(date '+%Y-%m-%d %H:%M:%S UTC')_ ğŸ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</div>" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ”” Notify on Release
        if: needs.create-release.result == 'success'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  ğŸ‰ RELEASE NOTIFICATION"
          echo ""
          echo "  Version ${{ needs.pre-release.outputs.version }} has been successfully released!"
          echo ""
          echo "  ğŸ”— View release: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: âš ï¸ Notify on Failure
        if: needs.create-release.result == 'failure'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  âš ï¸ RELEASE FAILED"
          echo ""
          echo "  The release pipeline for version ${{ needs.pre-release.outputs.version }} has failed."
          echo "  Please review the logs and fix the issues."
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"