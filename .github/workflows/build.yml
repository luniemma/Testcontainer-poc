name: ğŸš€ Build Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
  schedule:
    # Runs every day at 2:00 AM UTC
    - cron: '0 2 * * *'

# ğŸ” CRITICAL: These permissions are required for the workflow to function properly
permissions:
  contents: write          # needed for deploy-production and releases
  checks: write            # needed for check runs
  pull-requests: write     # needed for PR comments and updates
  issues: write            # CRITICAL: needed for creating PR comments (PRs are issues in GitHub API)
  security-events: write   # needed for security job (CodeQL / SARIF)

jobs:
  
  #######################################
  # WORKFLOW START BANNER
  #######################################
  workflow-start:
    name: ğŸ¬ Workflow Initialization
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ¯ Print Workflow Banner
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                                â•‘"
          echo "â•‘               ğŸš€ CI/CD PIPELINE STARTING ğŸš€                   â•‘"
          echo "â•‘                                                                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚                    WORKFLOW INFORMATION                        â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "ğŸ“¦ Repository:        ${{ github.repository }}"
          echo "ğŸ”€ Branch:            ${{ github.ref_name }}"
          echo "ğŸ“ Commit SHA:        ${{ github.sha }}"
          echo "ğŸ‘¤ Triggered by:      ${{ github.actor }}"
          echo "ğŸ­ Event:             ${{ github.event_name }}"
          echo "ğŸ”¢ Run Number:        #${{ github.run_number }}"
          echo "â° Started at:        $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
      
      - name: ğŸ“Š Create Workflow Start Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> $GITHUB_STEP_SUMMARY
          echo "â•‘                                                                â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•‘            ğŸš€ CI/CD PIPELINE EXECUTION STARTED                â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•‘                                                                â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "<div align='center'>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ Repository | \`${{ github.repository }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”€ Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“ Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ‘¤ Triggered By | **${{ github.actor }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ­ Event Type | **${{ github.event_name }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¢ Run Number | **#${{ github.run_number }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| â° Started At | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</div>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ¬ Pipeline Stages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The following stages will be executed:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. ğŸ—ï¸ **Build & Unit Tests**" >> $GITHUB_STEP_SUMMARY
          echo "2. ğŸ§ª **Integration Tests** (Testcontainers)" >> $GITHUB_STEP_SUMMARY
          echo "3. ğŸ³ **Docker Build & Push**" >> $GITHUB_STEP_SUMMARY
          echo "4. ğŸ’¨ **Smoke Tests** (Testcontainers Cloud)" >> $GITHUB_STEP_SUMMARY
          echo "5. ğŸ”’ **Security Scanning** (OWASP + CodeQL)" >> $GITHUB_STEP_SUMMARY
          echo "6. ğŸš€ **Production Deploy** (on version tags)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
  
  #######################################
  # MAIN BUILD JOB
  #######################################
  build:
    name: ğŸ—ï¸ Execute CI/CD Pipeline
    needs: workflow-start
    uses: ./.github/workflows/ci-cd.yml
    # âœ… CRITICAL FIX: Explicitly inherit permissions to reusable workflow
    # Without this, the reusable workflow will have default read-only permissions
    permissions:
      contents: write
      checks: write
      pull-requests: write
      issues: write          # CRITICAL: This enables PR comments!
      security-events: write
    with:
      java-version: "17"
      docker-platforms: "linux/amd64,linux/arm64"
      run-tests: true
      enable-security-scan: ${{ github.event_name == 'push' }}
      event-name: ${{ github.event_name }}
      debug-mode: false  # Set to true for verbose logging
    secrets:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      TC_CLOUD_TOKEN: ${{ secrets.TC_CLOUD_TOKEN }}
  
  #######################################
  # WORKFLOW COMPLETION
  #######################################
  workflow-complete:
    name: ğŸ¬ Workflow Completion
    runs-on: ubuntu-latest
    needs: build
    if: always()
    
    steps:
      - name: ğŸ“Š Print Completion Banner
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "  â•‘                                                       â•‘"
            echo "  â•‘         âœ…  WORKFLOW COMPLETED SUCCESSFULLY  âœ…      â•‘"
            echo "  â•‘                                                       â•‘"
            echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          elif [ "${{ needs.build.result }}" == "failure" ]; then
            echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "  â•‘                                                       â•‘"
            echo "  â•‘            âŒ  WORKFLOW FAILED  âŒ                   â•‘"
            echo "  â•‘                                                       â•‘"
            echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          elif [ "${{ needs.build.result }}" == "cancelled" ]; then
            echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "  â•‘                                                       â•‘"
            echo "  â•‘          âš ï¸   WORKFLOW CANCELLED  âš ï¸                 â•‘"
            echo "  â•‘                                                       â•‘"
            echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          else
            echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "  â•‘                                                       â•‘"
            echo "  â•‘          â­ï¸   WORKFLOW SKIPPED  â­ï¸                   â•‘"
            echo "  â•‘                                                       â•‘"
            echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          fi
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“Š Build Result:      ${{ needs.build.result }}"
          echo "â° Completed at:      $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”¢ Run Number:        #${{ github.run_number }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      
      - name: ğŸ“ˆ Create Final Summary
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> $GITHUB_STEP_SUMMARY
          echo "â•‘                                                                â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•‘              ğŸ WORKFLOW EXECUTION COMPLETED                  â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•‘                                                                â•‘" >> $GITHUB_STEP_SUMMARY
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "<div align='center'>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "## âœ… WORKFLOW SUCCESS" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘                                        â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘     ğŸ‰ ALL STAGES COMPLETED! ğŸ‰       â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘                                        â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘    The pipeline executed successfully  â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘                                        â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build.result }}" == "failure" ]; then
            echo "## âŒ WORKFLOW FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘                                        â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘        âš ï¸  PIPELINE FAILED  âš ï¸        â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘                                        â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘    Please review the logs above        â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•‘                                        â•‘" >> $GITHUB_STEP_SUMMARY
            echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.build.result }}" == "cancelled" ]; then
            echo "## âš ï¸ WORKFLOW CANCELLED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The workflow was cancelled before completion." >> $GITHUB_STEP_SUMMARY
          else
            echo "## â­ï¸ WORKFLOW SKIPPED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The workflow was skipped." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</div>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“‹ Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¯ Final Status | **${{ needs.build.result }}** |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¢ Run Number | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“¦ Repository | \`${{ github.repository }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”€ Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ‘¤ Triggered By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â° Completed At | $(date '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "### ğŸ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Review test results in the checks tab" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Check artifacts for reports and builds" >> $GITHUB_STEP_SUMMARY
            echo "- âœ… Review security scan results" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ github.event_name }}" != "pull_request" ]; then
              echo "- âœ… Docker image is ready for deployment" >> $GITHUB_STEP_SUMMARY
            fi
          elif [ "${{ needs.build.result }}" == "failure" ]; then
            echo "### ğŸ” Troubleshooting" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Check the failed job logs above" >> $GITHUB_STEP_SUMMARY
            echo "2. Review test failure reports in artifacts" >> $GITHUB_STEP_SUMMARY
            echo "3. Check for compilation or dependency errors" >> $GITHUB_STEP_SUMMARY
            echo "4. Verify all required secrets are configured" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<div align='center'>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Thank you for using the CI/CD Pipeline! ğŸš€_" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "</div>" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸ”” Notify on Failure
        if: failure() && needs.build.result == 'failure'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "  âš ï¸  ATTENTION: Pipeline Failed"
          echo ""
          echo "  Please check the logs and fix the issues."
          echo "  Run number: #${{ github.run_number }}"
          echo "  Branch: ${{ github.ref_name }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"